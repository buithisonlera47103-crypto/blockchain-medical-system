# 区块链医疗记录系统 - 部署指南

## 系统要求

### 硬件要求
- CPU: 4核心以上
- 内存: 8GB以上
- 存储: 50GB以上可用空间
- 网络: 稳定的互联网连接

### 软件要求
- 操作系统: Ubuntu 20.04+ / CentOS 8+ / macOS 10.15+ / Windows 10+
- Node.js: 18.x 或更高版本
- Docker: 20.10+ 和 Docker Compose 2.0+
- Git: 2.25+
- PostgreSQL: 13+
- Redis: 6.0+

## 环境准备

### 1. 安装Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# macOS (使用Homebrew)
brew install node@18

# 验证安装
node --version
npm --version
```

### 2. 安装Docker
```bash
# Ubuntu
sudo apt-get update
sudo apt-get install docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker

# CentOS
sudo yum install -y docker docker-compose
sudo systemctl start docker
sudo systemctl enable docker

# 添加用户到docker组
sudo usermod -aG docker $USER
```

### 3. 安装PostgreSQL
```bash
# Ubuntu
sudo apt-get install postgresql postgresql-contrib

# CentOS
sudo yum install postgresql-server postgresql-contrib
sudo postgresql-setup initdb

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 4. 安装Redis
```bash
# Ubuntu
sudo apt-get install redis-server

# CentOS
sudo yum install redis

# 启动服务
sudo systemctl start redis
sudo systemctl enable redis
```

## 项目部署

### 方式一：Docker Compose部署（推荐）

1. **克隆项目**
```bash
git clone <项目仓库地址>
cd blockchain-project
```

2. **配置环境变量**
```bash
# 复制环境变量模板
cp .env.template .env
cp backend-app/.env.example backend-app/.env

# 编辑配置文件
vim .env
vim backend-app/.env
```

3. **启动服务**
```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

4. **初始化数据库**
```bash
# 等待数据库启动完成
sleep 30

# 运行数据库迁移
docker-compose exec backend npm run migrate

# 初始化测试数据
docker-compose exec backend npm run seed
```

### 方式二：手动部署

1. **克隆和安装依赖**
```bash
git clone <项目仓库地址>
cd blockchain-project

# 安装根目录依赖
npm install

# 安装后端依赖
cd backend-app
npm install
cd ..

# 安装前端依赖
cd react-app
npm install
cd ..

# 安装区块链服务依赖
cd node-app
npm install
cd ..
```

2. **配置数据库**
```bash
# 创建数据库
sudo -u postgres psql
CREATE DATABASE medical_records;
CREATE USER medical_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE medical_records TO medical_user;
\q
```

3. **配置环境变量**
```bash
# 后端配置
cd backend-app
cp .env.example .env
vim .env

# 设置数据库连接
DB_HOST=localhost
DB_PORT=5432
DB_NAME=medical_records
DB_USER=medical_user
DB_PASSWORD=your_password

# 设置Redis连接
REDIS_HOST=localhost
REDIS_PORT=6379

# 设置JWT密钥
JWT_SECRET=your_jwt_secret_key
```

4. **启动Hyperledger Fabric网络**
```bash
cd fabric
./network.sh up createChannel -ca -s couchdb
./network.sh deployCC -ccn emr -ccp ../chaincode/emr -ccl javascript
```

5. **启动服务**
```bash
# 启动后端服务
cd backend-app
npm run build
npm start &

# 启动前端服务
cd ../react-app
npm run build
npm start &

# 启动区块链服务
cd ../node-app
npm start &
```

## 生产环境配置

### 1. 反向代理配置（Nginx）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # API接口
    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 区块链服务
    location /blockchain {
        proxy_pass http://localhost:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 3. 防火墙配置
```bash
# Ubuntu UFW
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS Firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 4. 系统服务配置
```bash
# 创建systemd服务文件
sudo vim /etc/systemd/system/medical-backend.service

[Unit]
Description=Medical Records Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/blockchain-project/backend-app
ExecStart=/usr/bin/npm start
Restart=always

[Install]
WantedBy=multi-user.target

# 启用服务
sudo systemctl enable medical-backend
sudo systemctl start medical-backend
```

## 监控和维护

### 1. 日志管理
```bash
# 配置日志轮转
sudo vim /etc/logrotate.d/medical-records

/path/to/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    copytruncate
}
```

### 2. 性能监控
```bash
# 安装监控工具
npm install -g pm2

# 使用PM2管理进程
pm2 start ecosystem.config.js
pm2 monit
```

### 3. 数据库备份
```bash
# 创建备份脚本
vim backup.sh

#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/medical_records"
mkdir -p $BACKUP_DIR

pg_dump -h localhost -U medical_user medical_records > $BACKUP_DIR/backup_$DATE.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "backup_*.sql" -mtime +30 -delete

# 设置定时任务
crontab -e
0 2 * * * /path/to/backup.sh
```

## 故障排除

### 常见问题

1. **端口冲突**
```bash
# 检查端口占用
netstat -tulpn | grep :3000
lsof -i :3000

# 杀死占用进程
kill -9 <PID>
```

2. **数据库连接失败**
```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 检查连接配置
psql -h localhost -U medical_user -d medical_records
```

3. **Docker容器问题**
```bash
# 查看容器状态
docker ps -a

# 查看容器日志
docker logs <container_name>

# 重启容器
docker-compose restart <service_name>
```

4. **Fabric网络问题**
```bash
# 重启Fabric网络
cd fabric
./network.sh down
./network.sh up createChannel -ca -s couchdb
```

### 性能优化

1. **数据库优化**
```sql
-- 创建索引
CREATE INDEX idx_medical_records_patient_id ON medical_records(patient_id);
CREATE INDEX idx_medical_records_created_at ON medical_records(created_at);

-- 分析查询性能
EXPLAIN ANALYZE SELECT * FROM medical_records WHERE patient_id = 1;
```

2. **缓存配置**
```bash
# Redis配置优化
vim /etc/redis/redis.conf

maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

3. **应用优化**
```javascript
// 连接池配置
const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20, // 最大连接数
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

## 安全配置

### 1. 数据库安全
```bash
# 修改默认端口
vim /etc/postgresql/13/main/postgresql.conf
port = 5433

# 限制连接
vim /etc/postgresql/13/main/pg_hba.conf
host medical_records medical_user 127.0.0.1/32 md5
```

### 2. 应用安全
```javascript
// 安全中间件配置
app.use(helmet());
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  credentials: true
}));
app.use(rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100 // 限制每个IP 100次请求
}));
```

### 3. 网络安全
```bash
# 配置fail2ban
sudo apt-get install fail2ban
sudo vim /etc/fail2ban/jail.local

[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
```

---

**部署支持：** 如遇到部署问题，请查看项目文档或联系技术支持团队。