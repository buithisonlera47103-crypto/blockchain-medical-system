# 系统架构设计

## 📖 概述

基于区块链的电子病历共享系统采用分层架构设计，遵循read111.md的技术规范，实现医疗数据的安全存储、隐私保护和跨机构共享。

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端展示层                               │
├─────────────────────────────────────────────────────────────┤
│  React应用  │  移动端App  │  管理控制台  │  第三方集成    │
└─────────────────────────────────────────────────────────────┘
                               ↕
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层                               │
├─────────────────────────────────────────────────────────────┤
│  用户管理   │  权限控制   │  病历管理   │  加密搜索      │
│  审计日志   │  通知服务   │  联邦学习   │  跨链桥接      │
└─────────────────────────────────────────────────────────────┘
                               ↕
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层                               │
├─────────────────────────────────────────────────────────────┤
│  MySQL数据库 │ IPFS分布式存储 │ Redis缓存 │ 区块链网络   │
└─────────────────────────────────────────────────────────────┘
                               ↕
┌─────────────────────────────────────────────────────────────┐
│                    基础设施层                               │
├─────────────────────────────────────────────────────────────┤
│  Docker容器  │  Kubernetes  │  负载均衡  │  监控告警     │
└─────────────────────────────────────────────────────────────┘
```

## 🧩 核心组件

### 1. 前端系统 (React App)

**技术栈**：React 18 + TypeScript + Ant Design + Redux Toolkit

**主要模块**：

- **用户界面**: 患者门户、医生工作台、管理控制台
- **状态管理**: Redux Toolkit管理全局状态
- **路由管理**: React Router实现SPA导航
- **国际化**: i18next支持多语言
- **UI组件**: Ant Design提供一致的界面体验

### 2. 后端系统 (Node.js API)

**技术栈**：Node.js + TypeScript + Express.js + MySQL

**核心服务**：

#### 2.1 用户管理服务 (UserService)

- 用户注册、登录、认证
- 基于角色的权限控制(RBAC)
- JWT令牌管理
- 多因素认证支持

#### 2.2 病历管理服务 (MedicalRecordService)

- 病历创建、编辑、查询
- 版本控制和历史管理
- 数字签名验证
- 权限检查和访问控制

#### 2.3 区块链服务 (BlockchainService)

- Hyperledger Fabric网络交互
- 智能合约调用
- 交易提交和查询
- 事件监听和处理

### 3. 区块链网络 (Hyperledger Fabric)

**智能合约 (EMR Chaincode)**：

```go
// 主要功能
- CreateRecord()      // 创建病历记录
- UpdateRecord()      // 更新病历记录
- QueryRecord()       // 查询病历记录
- GrantAccess()       // 授予访问权限
- RevokeAccess()      // 撤销访问权限
- GetAccessHistory()  // 获取访问历史
```

### 4. 存储系统

#### 4.1 MySQL关系数据库

**主要表结构**：

```sql
-- 用户表
USERS (user_id, username, password_hash, role_id, created_at)

-- 病历表
MEDICAL_RECORDS (record_id, patient_id, creator_id, blockchain_tx_hash, created_at)

-- 访问权限表
ACCESS_PERMISSIONS (permission_id, record_id, grantee_id, action_type, expires_at)

-- IPFS元数据表
IPFS_METADATA (cid, record_id, file_size, encryption_key_ref, upload_date)
```

#### 4.2 IPFS分布式存储

- **文件存储**: 加密的病历文件存储
- **内容寻址**: 基于内容哈希的去重存储
- **分布式访问**: 多节点冗余保证可用性
- **版本控制**: 支持文件版本管理

## 🔐 安全架构

### 1. 认证授权体系

```
用户请求 → JWT验证 → 角色检查 → 权限验证 → 资源访问
```

### 2. 数据加密保护

- **传输加密**: TLS 1.3端到端加密
- **存储加密**: AES-256数据库字段加密
- **文件加密**: 病历文件ChaCha20-Poly1305加密
- **搜索加密**: 可搜索加密算法保护隐私

### 3. 区块链安全

- **身份管理**: Fabric CA证书管理
- **访问控制**: 基于MSP的组织权限
- **数据完整性**: 默克尔树验证
- **共识机制**: RAFT共识保证一致性

## 📊 数据流设计

### 1. 病历创建流程

```
用户上传 → 文件加密 → IPFS存储 → 生成索引 → 区块链记录 → 数据库更新 → 返回结果
```

### 2. 权限授权流程

```
权限申请 → 智能合约验证 → 权限记录 → 通知相关方 → 审计日志 → 权限生效
```

### 3. 加密搜索流程

```
搜索请求 → 关键词加密 → 权限验证 → 索引匹配 → 结果解密 → 返回数据
```

## 🚀 性能优化

### 1. 缓存策略

- **多级缓存**: Redis + 应用内存缓存
- **查询优化**: 数据库索引优化
- **CDN加速**: 静态资源分发
- **连接池**: 数据库连接复用

### 2. 负载均衡

- **应用层**: Nginx反向代理
- **数据库**: 读写分离
- **区块链**: 多节点负载分散
- **IPFS**: 分布式节点访问

### 3. 监控告警

- **性能监控**: Prometheus + Grafana
- **日志聚合**: ELK Stack
- **健康检查**: 自动故障检测
- **告警通知**: 多渠道告警推送

## 🔄 扩展性设计

### 1. 横向扩展

- **微服务化**: 按业务域拆分服务
- **容器化**: Docker + Kubernetes
- **服务网格**: Istio流量管理
- **自动伸缩**: HPA自动扩容

### 2. 跨链互操作

- **多链支持**: 以太坊、币安智能链桥接
- **跨链资产**: 病历NFT化转移
- **统一接口**: 多链适配器模式
- **状态同步**: 跨链数据一致性

## 📈 部署架构

### 1. 开发环境

```
开发机 → Docker Compose → 本地测试网络 → 集成测试
```

### 2. 生产环境

```
Kubernetes集群 → 多节点Fabric网络 → 高可用数据库 → 监控告警
```

### 3. 灾备方案

- **数据备份**: 定时全量+增量备份
- **异地容灾**: 多地域部署
- **故障切换**: 自动故障转移
- **数据恢复**: 快速恢复机制

这个架构设计确保了系统的安全性、可扩展性和高可用性，完全符合read111.md的技术要求。
