openapi: 3.0.0
info:
  title: åŒºå—é“¾ç”µå­ç—…å†å…±äº«ç³»ç»ŸAPI
  version: 1.0.0
  description: |
    åŸºäºåŒºå—é“¾çš„ç”µå­ç—…å†å…±äº«ç³»ç»ŸRESTful APIæ–‡æ¡£

    ## åŠŸèƒ½ç‰¹æ€§
    - ğŸ” åŸºäºJWTçš„ç”¨æˆ·è®¤è¯
    - ğŸ“ ç—…å†æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
    - ğŸ”’ ç»†ç²’åº¦æƒé™æ§åˆ¶
    - ğŸ”— åŒºå—é“¾å­˜è¯å’Œè¿½æº¯
    - ğŸ“Š å®Œæ•´çš„å®¡è®¡æ—¥å¿—

    ## è®¤è¯æ–¹å¼
    æ‰€æœ‰APIéƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«æœ‰æ•ˆçš„JWTä»¤ç‰Œï¼š
    ```
    Authorization: Bearer <your-jwt-token>
    ```
  contact:
    name: EMR System Support
    email: support@emr-system.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/v1
    description: å¼€å‘ç¯å¢ƒ
  - url: https://api.emr-system.com/v1
    description: ç”Ÿäº§ç¯å¢ƒ

# å®‰å…¨æ¨¡å¼å®šä¹‰
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWTä»¤ç‰Œè®¤è¯

  schemas:
    User:
      type: object
      properties:
        userId:
          type: string
          format: uuid
          description: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
        username:
          type: string
          description: ç”¨æˆ·å
        email:
          type: string
          format: email
          description: é‚®ç®±åœ°å€
        role:
          type: string
          enum: [patient, doctor, hospital_admin, system_admin, auditor]
          description: ç”¨æˆ·è§’è‰²
        fullName:
          type: string
          description: ç”¨æˆ·å…¨å
        department:
          type: string
          description: æ‰€å±ç§‘å®¤
        createdAt:
          type: string
          format: date-time
          description: åˆ›å»ºæ—¶é—´

    MedicalRecord:
      type: object
      properties:
        recordId:
          type: string
          format: uuid
          description: ç—…å†è®°å½•ID
        patientId:
          type: string
          format: uuid
          description: æ‚£è€…ID
        creatorId:
          type: string
          format: uuid
          description: åˆ›å»ºè€…ID
        title:
          type: string
          description: ç—…å†æ ‡é¢˜
        description:
          type: string
          description: ç—…å†æè¿°
        recordType:
          type: string
          enum: [CT, MRI, X_RAY, ECG, BLOOD_TEST, PATHOLOGY, OTHER]
          description: ç—…å†ç±»å‹
        department:
          type: string
          description: ç§‘å®¤
        ipfsCid:
          type: string
          description: IPFSå†…å®¹æ ‡è¯†ç¬¦
        blockchainTxId:
          type: string
          description: åŒºå—é“¾äº¤æ˜“ID
        fileSize:
          type: integer
          description: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        fileHash:
          type: string
          description: æ–‡ä»¶SHA-256å“ˆå¸Œ
        createdAt:
          type: string
          format: date-time
          description: åˆ›å»ºæ—¶é—´

    Permission:
      type: object
      properties:
        permissionId:
          type: string
          format: uuid
          description: æƒé™ID
        recordId:
          type: string
          format: uuid
          description: ç—…å†ID
        granteeId:
          type: string
          format: uuid
          description: è¢«æˆæƒè€…ID
        grantorId:
          type: string
          format: uuid
          description: æˆæƒè€…ID
        permissionType:
          type: string
          enum: [read, write, share, audit]
          description: æƒé™ç±»å‹
        status:
          type: string
          enum: [active, expired, revoked]
          description: æƒé™çŠ¶æ€
        grantedAt:
          type: string
          format: date-time
          description: æˆæƒæ—¶é—´
        expiresAt:
          type: string
          format: date-time
          description: è¿‡æœŸæ—¶é—´

    Error:
      type: object
      properties:
        error:
          type: string
          description: é”™è¯¯ç±»å‹
        message:
          type: string
          description: é”™è¯¯æ¶ˆæ¯
        code:
          type: integer
          description: é”™è¯¯ä»£ç 
        timestamp:
          type: string
          format: date-time
          description: é”™è¯¯æ—¶é—´

# å…¨å±€å®‰å…¨è¦æ±‚
security:
  - bearerAuth: []

paths:
  # è®¤è¯ç›¸å…³æ¥å£
  /auth/register:
    post:
      tags:
        - Authentication
      summary: ç”¨æˆ·æ³¨å†Œ
      description: æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆæ‚£è€…ã€åŒ»ç”Ÿæˆ–ç®¡ç†å‘˜ï¼‰
      security: [] # æ³¨å†Œæ¥å£ä¸éœ€è¦è®¤è¯
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, email, password, role]
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                  description: å¯†ç è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—
                role:
                  type: string
                  enum: [patient, doctor, hospital_admin]
                fullName:
                  type: string
                department:
                  type: string
                licenseNumber:
                  type: string
                  description: åŒ»ç”Ÿæ‰§ä¸šè¯å·ï¼ˆä»…åŒ»ç”Ÿéœ€è¦ï¼‰
      responses:
        "201":
          description: æ³¨å†ŒæˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    format: uuid
                  message:
                    type: string
        "400":
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      tags:
        - Authentication
      summary: ç”¨æˆ·ç™»å½•
      description: ç”¨æˆ·ç™»å½•è·å–JWTä»¤ç‰Œ
      security: [] # ç™»å½•æ¥å£ä¸éœ€è¦è®¤è¯
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                password:
                  type: string
                mfaCode:
                  type: string
                  description: å¤šå› å­è®¤è¯ä»£ç ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      responses:
        "200":
          description: ç™»å½•æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWTè®¿é—®ä»¤ç‰Œ
                  refreshToken:
                    type: string
                    description: åˆ·æ–°ä»¤ç‰Œ
                  expiresIn:
                    type: integer
                    description: ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
                  user:
                    $ref: "#/components/schemas/User"
        "401":
          description: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ç—…å†ç®¡ç†æ¥å£
  /records:
    get:
      tags:
        - Medical Records
      summary: è·å–ç—…å†åˆ—è¡¨
      description: è·å–å½“å‰ç”¨æˆ·å¯è®¿é—®çš„ç—…å†åˆ—è¡¨
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, title, record_type]
            default: created_at
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: recordType
          in: query
          schema:
            type: string
            enum: [CT, MRI, X_RAY, ECG, BLOOD_TEST, PATHOLOGY, OTHER]
        - name: department
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
          description: æœç´¢å…³é”®è¯
      responses:
        "200":
          description: æˆåŠŸè·å–ç—…å†åˆ—è¡¨
          content:
            application/json:
              schema:
                type: object
                properties:
                  records:
                    type: array
                    items:
                      $ref: "#/components/schemas/MedicalRecord"
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      totalPages:
                        type: integer

    post:
      tags:
        - Medical Records
      summary: ä¸Šä¼ æ–°ç—…å†
      description: ä¸Šä¼ æ–°çš„ç—…å†æ–‡ä»¶åˆ°ç³»ç»Ÿ
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, patientId, title, recordType]
              properties:
                file:
                  type: string
                  format: binary
                  description: ç—…å†æ–‡ä»¶
                patientId:
                  type: string
                  format: uuid
                  description: æ‚£è€…ID
                title:
                  type: string
                  description: ç—…å†æ ‡é¢˜
                description:
                  type: string
                  description: ç—…å†æè¿°
                recordType:
                  type: string
                  enum: [CT, MRI, X_RAY, ECG, BLOOD_TEST, PATHOLOGY, OTHER]
                department:
                  type: string
                  description: ç§‘å®¤
      responses:
        "201":
          description: ç—…å†ä¸Šä¼ æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  recordId:
                    type: string
                    format: uuid
                  ipfsCid:
                    type: string
                  blockchainTxId:
                    type: string
                  message:
                    type: string

  /records/{recordId}:
    get:
      tags:
        - Medical Records
      summary: è·å–ç—…å†è¯¦æƒ…
      description: è·å–æŒ‡å®šç—…å†çš„è¯¦ç»†ä¿¡æ¯
      parameters:
        - name: recordId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: æˆåŠŸè·å–ç—…å†è¯¦æƒ…
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/MedicalRecord"
                  - type: object
                    properties:
                      content:
                        type: string
                        description: è§£å¯†åçš„ç—…å†å†…å®¹ï¼ˆBase64ç¼–ç ï¼‰
        "403":
          description: æ— æƒé™è®¿é—®è¯¥ç—…å†
        "404":
          description: ç—…å†ä¸å­˜åœ¨

  /records/{recordId}/download:
    get:
      tags:
        - Medical Records
      summary: ä¸‹è½½ç—…å†æ–‡ä»¶
      description: ä¸‹è½½æŒ‡å®šç—…å†çš„åŸå§‹æ–‡ä»¶
      parameters:
        - name: recordId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: æ–‡ä»¶ä¸‹è½½æˆåŠŸ
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "403":
          description: æ— æƒé™ä¸‹è½½è¯¥æ–‡ä»¶
        "404":
          description: æ–‡ä»¶ä¸å­˜åœ¨

  # æƒé™ç®¡ç†æ¥å£
  /permissions/request:
    post:
      tags:
        - Permissions
      summary: è¯·æ±‚è®¿é—®æƒé™
      description: å‘ç—…å†æ‰€æœ‰è€…è¯·æ±‚è®¿é—®æƒé™
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recordId, requestedPermissions, purpose]
              properties:
                recordId:
                  type: string
                  format: uuid
                requestedPermissions:
                  type: array
                  items:
                    type: string
                    enum: [read, write, share]
                purpose:
                  type: string
                  description: è¯·æ±‚ç›®çš„
                urgency:
                  type: string
                  enum: [low, normal, high, emergency]
                  default: normal
      responses:
        "201":
          description: æƒé™è¯·æ±‚å·²æäº¤
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                    format: uuid
                  message:
                    type: string

  /permissions/check:
    post:
      tags:
        - Permissions
      summary: æ£€æŸ¥è®¿é—®æƒé™
      description: æ£€æŸ¥å½“å‰ç”¨æˆ·å¯¹æŒ‡å®šç—…å†çš„è®¿é—®æƒé™
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recordId, action]
              properties:
                recordId:
                  type: string
                  format: uuid
                action:
                  type: string
                  enum: [read, write, share, audit]
      responses:
        "200":
          description: æƒé™æ£€æŸ¥ç»“æœ
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasAccess:
                    type: boolean
                  permissions:
                    type: array
                    items:
                      type: string
                  expiresAt:
                    type: string
                    format: date-time

tags:
  - name: Authentication
    description: ç”¨æˆ·è®¤è¯ç›¸å…³æ¥å£
  - name: Medical Records
    description: ç—…å†ç®¡ç†ç›¸å…³æ¥å£
  - name: Permissions
    description: æƒé™ç®¡ç†ç›¸å…³æ¥å£
  - name: Audit
    description: å®¡è®¡æ—¥å¿—ç›¸å…³æ¥å£
