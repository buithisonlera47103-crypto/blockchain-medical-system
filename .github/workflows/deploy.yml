name: EMRåŒºå—é“¾ç³»ç»Ÿ CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  KUBERNETES_NAMESPACE: emr-namespace

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: |
            backend-app/package-lock.json
            react-app/package-lock.json

      - name: å®‰è£…åç«¯ä¾èµ–
        working-directory: ./backend-app
        run: npm ci

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./react-app
        run: npm ci

      - name: åç«¯ä»£ç æ£€æŸ¥
        working-directory: ./backend-app
        run: |
          npm run lint
          npm run type-check

      - name: å‰ç«¯ä»£ç æ£€æŸ¥
        working-directory: ./react-app
        run: |
          npm run lint
          npm run type-check

      - name: åç«¯å•å…ƒæµ‹è¯•
        working-directory: ./backend-app
        run: npm run test:unit
        env:
          NODE_ENV: test

      - name: å‰ç«¯å•å…ƒæµ‹è¯•
        working-directory: ./react-app
        run: npm run test -- --coverage --watchAll=false

      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        with:
          files: |
            ./backend-app/coverage/lcov.info
            ./react-app/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ä¸Šä¼ Trivyæ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: npm audit åç«¯
        working-directory: ./backend-app
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: npm audit å‰ç«¯
        working-directory: ./react-app
        run: npm audit --audit-level=high
        continue-on-error: true

  # æ„å»ºDockeré•œåƒ
  build-images:
    name: æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan]
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–åç«¯é•œåƒå…ƒæ•°æ®
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: æå–å‰ç«¯é•œåƒå…ƒæ•°æ®
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/docker/Dockerfile.backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/docker/Dockerfile.frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: é•œåƒå®‰å…¨æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta-backend.outputs.tags }}
          format: "sarif"
          output: "backend-trivy-results.sarif"

      - name: ä¸Šä¼ é•œåƒæ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "backend-trivy-results.sarif"

  # é›†æˆæµ‹è¯•
  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name != 'pull_request'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: emr_blockchain_test
          MYSQL_USER: emr_user
          MYSQL_PASSWORD: password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

      ipfs:
        image: ipfs/kubo:latest
        ports:
          - 5001:5001
          - 8080:8080

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend-app/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ./backend-app
        run: npm ci

      - name: ç­‰å¾…æœåŠ¡å°±ç»ª
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5001/api/v0/version; do sleep 2; done'
          timeout 60 bash -c 'until mysqladmin ping -h localhost -u root -ppassword; do sleep 2; done'

      - name: åˆå§‹åŒ–æ•°æ®åº“
        working-directory: ./backend-app
        run: |
          mysql -h localhost -u root -ppassword emr_blockchain_test < ../deployment/docker/init.sql

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        working-directory: ./backend-app
        run: npm run test:integration
        env:
          NODE_ENV: test
          MYSQL_URL: mysql://emr_user:password@localhost:3306/emr_blockchain_test
          REDIS_URL: redis://localhost:6379
          IPFS_URL: http://localhost:5001
          JWT_SECRET: test-secret

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-images, integration-test]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.emr.example.com

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: é…ç½®Kubernetesä¸Šä¸‹æ–‡
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl config current-context

      - name: æ›´æ–°é•œåƒæ ‡ç­¾
        run: |
          export KUBECONFIG=kubeconfig
          kubectl set image deployment/backend-deployment backend=${{ needs.build-images.outputs.backend-image }} -n ${{ env.KUBERNETES_NAMESPACE }}-staging
          kubectl set image deployment/frontend-deployment frontend=${{ needs.build-images.outputs.frontend-image }} -n ${{ env.KUBERNETES_NAMESPACE }}-staging

      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: |
          export KUBECONFIG=kubeconfig
          kubectl rollout status deployment/backend-deployment -n ${{ env.KUBERNETES_NAMESPACE }}-staging --timeout=600s
          kubectl rollout status deployment/frontend-deployment -n ${{ env.KUBERNETES_NAMESPACE }}-staging --timeout=600s

      - name: è¿è¡Œå¥åº·æ£€æŸ¥
        run: |
          cd deployment/scripts
          node healthcheck.js --url https://staging.emr.example.com

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-images, integration-test]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: production
      url: https://emr.example.com

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: é…ç½®Kubernetesä¸Šä¸‹æ–‡
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl config current-context

      - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
        run: |
          export KUBECONFIG=kubeconfig
          kubectl get deployment backend-deployment -n ${{ env.KUBERNETES_NAMESPACE }} -o yaml > backup-backend-deployment.yaml
          kubectl get deployment frontend-deployment -n ${{ env.KUBERNETES_NAMESPACE }} -o yaml > backup-frontend-deployment.yaml

      - name: è“ç»¿éƒ¨ç½² - åˆ›å»ºæ–°ç‰ˆæœ¬
        run: |
          export KUBECONFIG=kubeconfig
          # åˆ›å»ºæ–°çš„deploymentå‰¯æœ¬
          sed 's/backend-deployment/backend-deployment-new/g' backup-backend-deployment.yaml | kubectl apply -f -
          sed 's/frontend-deployment/frontend-deployment-new/g' backup-frontend-deployment.yaml | kubectl apply -f -

          # æ›´æ–°é•œåƒ
          kubectl set image deployment/backend-deployment-new backend=${{ needs.build-images.outputs.backend-image }} -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl set image deployment/frontend-deployment-new frontend=${{ needs.build-images.outputs.frontend-image }} -n ${{ env.KUBERNETES_NAMESPACE }}

      - name: ç­‰å¾…æ–°ç‰ˆæœ¬å°±ç»ª
        run: |
          export KUBECONFIG=kubeconfig
          kubectl rollout status deployment/backend-deployment-new -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=600s
          kubectl rollout status deployment/frontend-deployment-new -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=600s

      - name: å¥åº·æ£€æŸ¥æ–°ç‰ˆæœ¬
        run: |
          cd deployment/scripts
          # ä¸´æ—¶åˆ‡æ¢æµé‡åˆ°æ–°ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•
          export KUBECONFIG=../../kubeconfig
          kubectl patch service backend-service -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"spec":{"selector":{"app":"backend-new"}}}'
          kubectl patch service frontend-service -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"spec":{"selector":{"app":"frontend-new"}}}'

          # è¿è¡Œå¥åº·æ£€æŸ¥
          sleep 30
          node healthcheck.js --url https://emr.example.com

      - name: åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
        run: |
          export KUBECONFIG=kubeconfig
          # åˆ é™¤æ—§ç‰ˆæœ¬
          kubectl delete deployment backend-deployment -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl delete deployment frontend-deployment -n ${{ env.KUBERNETES_NAMESPACE }}

          # é‡å‘½åæ–°ç‰ˆæœ¬
          kubectl patch deployment backend-deployment-new -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"metadata":{"name":"backend-deployment"}}'
          kubectl patch deployment frontend-deployment-new -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"metadata":{"name":"frontend-deployment"}}'

          # æ¢å¤æœåŠ¡é€‰æ‹©å™¨
          kubectl patch service backend-service -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"spec":{"selector":{"app":"backend"}}}'
          kubectl patch service frontend-service -n ${{ env.KUBERNETES_NAMESPACE }} -p '{"spec":{"selector":{"app":"frontend"}}}'

      - name: æœ€ç»ˆå¥åº·æ£€æŸ¥
        run: |
          cd deployment/scripts
          sleep 30
          node healthcheck.js --url https://emr.example.com

      - name: é€šçŸ¥éƒ¨ç½²æˆåŠŸ
        if: success()
        run: |
          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ github.event.release.tag_name }}"
          echo "è®¿é—®åœ°å€: https://emr.example.com"

      - name: å›æ»šéƒ¨ç½²
        if: failure()
        run: |
          export KUBECONFIG=kubeconfig
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œæ­£åœ¨å›æ»š..."
          kubectl apply -f backup-backend-deployment.yaml
          kubectl apply -f backup-frontend-deployment.yaml
          kubectl delete deployment backend-deployment-new frontend-deployment-new -n ${{ env.KUBERNETES_NAMESPACE }} --ignore-not-found

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: å®‰è£…k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: è¿è¡Œè´Ÿè½½æµ‹è¯•
        run: |
          k6 run --out json=performance-results.json deployment/tests/load-test.js

      - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results.json

  # æ¸…ç†æ—§é•œåƒ
  cleanup:
    name: æ¸…ç†æ—§é•œåƒ
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && github.event_name == 'release'

    steps:
      - name: æ¸…ç†æ—§çš„å®¹å™¨é•œåƒ
        uses: actions/delete-package-versions@v4
        with:
          package-name: ${{ env.IMAGE_NAME_BACKEND }}
          package-type: container
          min-versions-to-keep: 5
          delete-only-untagged-versions: true

      - name: æ¸…ç†æ—§çš„å‰ç«¯é•œåƒ
        uses: actions/delete-package-versions@v4
        with:
          package-name: ${{ env.IMAGE_NAME_FRONTEND }}
          package-type: container
          min-versions-to-keep: 5
          delete-only-untagged-versions: true
