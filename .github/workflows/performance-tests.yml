name: Performance Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_duration:
        description: "æµ‹è¯•æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
        required: false
        default: "15"
        type: string
      max_users:
        description: "æœ€å¤§å¹¶å‘ç”¨æˆ·æ•°"
        required: false
        default: "200"
        type: string

jobs:
  performance-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: emr_blockchain
          MYSQL_USER: emr_user
          MYSQL_PASSWORD: emr_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "backend-app/package-lock.json"

      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install Artillery
        run: npm install -g artillery@latest

      - name: Install backend dependencies
        working-directory: ./backend-app
        run: npm --prefix backend-app ci

      - name: Setup environment variables
        working-directory: ./backend-app
        run: |
          cp .env.example .env
          echo "MYSQL_HOST=localhost" >> .env
          echo "MYSQL_PORT=3306" >> .env
          echo "MYSQL_USER=emr_user" >> .env
          echo "MYSQL_PASSWORD=emr_password" >> .env
          echo "MYSQL_DATABASE=emr_blockchain" >> .env
          echo "REDIS_HOST=localhost" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "JWT_SECRET=test_jwt_secret_key_for_ci" >> .env
          echo "NODE_ENV=test" >> .env
          echo "PORT=3001" >> .env

          # å¤åˆ¶ä¼˜åŒ–ç¯å¢ƒå˜é‡
          cp .env.optimize .env.optimize.ci
          echo "PERFORMANCE_TARGET_TPS=1000" >> .env.optimize.ci
          echo "PERFORMANCE_TARGET_RESPONSE_TIME=500" >> .env.optimize.ci
          echo "PERFORMANCE_TARGET_ERROR_RATE=0.5" >> .env.optimize.ci
          echo "MYSQL_POOL_SIZE=50" >> .env.optimize.ci
          echo "REDIS_MAX_MEMORY=1gb" >> .env.optimize.ci

      - name: Wait for services
        run: |
          echo "ç­‰å¾…MySQLå¯åŠ¨..."
          timeout 60 bash -c 'until mysqladmin ping -h localhost -P 3306 -u root -proot_password --silent; do sleep 1; done'
          echo "ç­‰å¾…Rediså¯åŠ¨..."
          timeout 60 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'

      - name: Initialize database
        working-directory: ./backend-app
        run: |
          mysql -h localhost -P 3306 -u root -proot_password emr_blockchain < sql/init.sql || true
          npm --prefix backend-app run db:migrate || true

      - name: Build application
        working-directory: ./backend-app
        run: npm --prefix backend-app run build

      - name: Start application in background
        working-directory: ./backend-app
        run: |
          npm start &
          echo $! > app.pid

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
          timeout 60 bash -c 'until curl -f http://localhost:3001/health; do sleep 2; done'

      - name: Run performance analysis
        working-directory: ./backend-app
        run: |
          echo "è¿è¡Œæ€§èƒ½åˆ†æ..."
          npm --prefix backend-app run analyze || echo "åˆ†æè„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: Run load tests
        working-directory: ./backend-app
        env:
          TEST_DURATION: ${{ github.event.inputs.test_duration || '15' }}
          MAX_USERS: ${{ github.event.inputs.max_users || '200' }}
        run: |
          echo "å¼€å§‹è´Ÿè½½æµ‹è¯•..."
          echo "æµ‹è¯•æŒç»­æ—¶é—´: ${TEST_DURATION}åˆ†é’Ÿ"
          echo "æœ€å¤§å¹¶å‘ç”¨æˆ·: ${MAX_USERS}"

          # è¿è¡ŒArtilleryæµ‹è¯•
          echo "è¿è¡ŒArtilleryè´Ÿè½½æµ‹è¯•..."
          npm --prefix backend-app run load-test || echo "Artilleryæµ‹è¯•å®Œæˆ"

          # è¿è¡ŒK6æµ‹è¯•
          echo "è¿è¡ŒK6æ€§èƒ½æµ‹è¯•..."
          npm --prefix backend-app run k6-test || echo "K6æµ‹è¯•å®Œæˆ"

      - name: Apply performance optimizations
        working-directory: ./backend-app
        run: |
          echo "åº”ç”¨æ€§èƒ½ä¼˜åŒ–..."
          npm --prefix backend-app run optimize || echo "ä¼˜åŒ–è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: Generate performance report
        working-directory: ./backend-app
        run: |
          echo "ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š..."
          npm --prefix backend-app run performance:report || echo "æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports-${{ github.run_number }}
          path: |
            backend-app/reports/performance/
            backend-app/test/performance/results/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            backend-app/artillery-report.json
            backend-app/k6-results.json
          retention-days: 7

      - name: Performance regression check
        working-directory: ./backend-app
        run: |
          echo "æ£€æŸ¥æ€§èƒ½å›å½’..."

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ€§èƒ½æŠ¥å‘Š
          if [ -f "reports/performance/analysis.json" ]; then
            echo "åˆ†ææ€§èƒ½æŒ‡æ ‡..."
            
            # ä½¿ç”¨jqè§£æJSONæŠ¥å‘Šï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if command -v jq &> /dev/null; then
              OVERALL_SCORE=$(jq -r '.summary.overallScore // "N/A"' reports/performance/analysis.json)
              TPS=$(jq -r '.metrics.tps // "N/A"' reports/performance/analysis.json)
              RESPONSE_TIME=$(jq -r '.metrics.responseTime.p95 // "N/A"' reports/performance/analysis.json)
              ERROR_RATE=$(jq -r '.metrics.errorRate // "N/A"' reports/performance/analysis.json)
              
              echo "æ€§èƒ½æŒ‡æ ‡æ‘˜è¦:"
              echo "- æ€»ä½“è¯„åˆ†: $OVERALL_SCORE"
              echo "- TPS: $TPS"
              echo "- P95å“åº”æ—¶é—´: $RESPONSE_TIME ms"
              echo "- é”™è¯¯ç‡: $ERROR_RATE%"
              
              # è®¾ç½®æ€§èƒ½é˜ˆå€¼æ£€æŸ¥
              if [ "$TPS" != "N/A" ] && [ "$TPS" != "null" ]; then
                if (( $(echo "$TPS < 800" | bc -l) )); then
                  echo "âš ï¸ è­¦å‘Š: TPS ($TPS) ä½äºé¢„æœŸé˜ˆå€¼ (800)"
                  echo "performance_warning=true" >> $GITHUB_ENV
                fi
              fi
              
              if [ "$RESPONSE_TIME" != "N/A" ] && [ "$RESPONSE_TIME" != "null" ]; then
                if (( $(echo "$RESPONSE_TIME > 600" | bc -l) )); then
                  echo "âš ï¸ è­¦å‘Š: P95å“åº”æ—¶é—´ ($RESPONSE_TIME ms) è¶…è¿‡é¢„æœŸé˜ˆå€¼ (600ms)"
                  echo "performance_warning=true" >> $GITHUB_ENV
                fi
              fi
              
              if [ "$ERROR_RATE" != "N/A" ] && [ "$ERROR_RATE" != "null" ]; then
                if (( $(echo "$ERROR_RATE > 1.0" | bc -l) )); then
                  echo "âš ï¸ è­¦å‘Š: é”™è¯¯ç‡ ($ERROR_RATE%) è¶…è¿‡é¢„æœŸé˜ˆå€¼ (1.0%)"
                  echo "performance_warning=true" >> $GITHUB_ENV
                fi
              fi
            else
              echo "jqæœªå®‰è£…ï¼Œè·³è¿‡è¯¦ç»†åˆ†æ"
            fi
          else
            echo "æœªæ‰¾åˆ°æ€§èƒ½åˆ†ææŠ¥å‘Š"
          fi

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './backend-app/reports/performance/analysis.json';

            let comment = '## ğŸš€ æ€§èƒ½æµ‹è¯•ç»“æœ\n\n';

            if (fs.existsSync(path)) {
              try {
                const report = JSON.parse(fs.readFileSync(path, 'utf8'));
                
                comment += `### ğŸ“Š æ€§èƒ½æŒ‡æ ‡\n`;
                comment += `- **TPS**: ${report.metrics?.tps || 'N/A'}\n`;
                comment += `- **P95å“åº”æ—¶é—´**: ${report.metrics?.responseTime?.p95 || 'N/A'} ms\n`;
                comment += `- **é”™è¯¯ç‡**: ${report.metrics?.errorRate || 'N/A'}%\n`;
                comment += `- **æ€»ä½“è¯„åˆ†**: ${report.summary?.overallScore || 'N/A'}\n\n`;
                
                if (report.recommendations && report.recommendations.length > 0) {
                  comment += `### ğŸ’¡ ä¼˜åŒ–å»ºè®®\n`;
                  report.recommendations.slice(0, 3).forEach((rec, index) => {
                    comment += `${index + 1}. ${rec}\n`;
                  });
                  comment += '\n';
                }
                
                if (process.env.performance_warning === 'true') {
                  comment += 'âš ï¸ **æ³¨æ„**: æ£€æµ‹åˆ°æ€§èƒ½æŒ‡æ ‡ä½äºé¢„æœŸé˜ˆå€¼ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚\n\n';
                } else {
                  comment += 'âœ… **çŠ¶æ€**: æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡å‡åœ¨é¢„æœŸèŒƒå›´å†…ã€‚\n\n';
                }
                
              } catch (error) {
                comment += 'âŒ è§£ææ€§èƒ½æŠ¥å‘Šæ—¶å‡ºé”™\n\n';
              }
            } else {
              comment += 'âŒ æœªæ‰¾åˆ°æ€§èƒ½æµ‹è¯•æŠ¥å‘Š\n\n';
            }

            comment += `### ğŸ“ æŠ¥å‘Šæ–‡ä»¶\n`;
            comment += `æ€§èƒ½æµ‹è¯•æŠ¥å‘Šå·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼Œå¯åœ¨ [Actions](${context.payload.repository.html_url}/actions/runs/${context.runId}) é¡µé¢ä¸‹è½½ã€‚\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Stop application
        if: always()
        working-directory: ./backend-app
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi

          # ç¡®ä¿æ‰€æœ‰ç›¸å…³è¿›ç¨‹éƒ½è¢«ç»ˆæ­¢
          pkill -f "node.*dist/server.js" || true
          pkill -f "npm.*start" || true

      - name: Cleanup
        if: always()
        run: |
          docker ps -q | xargs -r docker stop
          docker system prune -f
