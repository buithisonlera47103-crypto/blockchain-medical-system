name: ğŸš€ EMRåŒºå—é“¾ç³»ç»Ÿ CI/CDæµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend
  NODE_VERSION: '18.x'
  GO_VERSION: '1.21'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          backend-app/package-lock.json
          react-app/package-lock.json

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm --prefix backend-app ci
        cd react-app && npm ci

    - name: ğŸ§¹ ESLintæ£€æŸ¥ (åç«¯)
      run: npm --prefix backend-app run lint
      continue-on-error: true

    - name: ğŸ§¹ TypeScriptæ£€æŸ¥ (å‰ç«¯)
      run: cd react-app && npm run type-check
      continue-on-error: true

    - name: ğŸ”’ å®‰å…¨æ¼æ´æ‰«æ
      run: |
        cd backend-app && npm audit --audit-level moderate
        cd ../react-app && npm audit --audit-level moderate
      continue-on-error: true

    - name: ğŸ“Š SonarCloudä»£ç åˆ†æ
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: emr_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          backend-app/package-lock.json
          react-app/package-lock.json

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm --prefix backend-app ci
        cd react-app && npm ci

    - name: ğŸ§ª è¿è¡Œåç«¯å•å…ƒæµ‹è¯•
      env:
        NODE_ENV: test
        MYSQL_HOST: localhost
        MYSQL_PORT: 3306
        MYSQL_DATABASE: emr_test
        MYSQL_USER: root
        MYSQL_PASSWORD: test_password
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        JWT_SECRET: test_jwt_secret
      run: npm --prefix backend-app run test:unit

    - name: ğŸ§ª è¿è¡Œå‰ç«¯å•å…ƒæµ‹è¯•
      env:
        CI: true
      run: cd react-app && npm test -- --coverage --watchAll=false

    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        files: |
          ./backend-app/coverage/lcov.info
          ./react-app/coverage/lcov.info
        flags: unittests
        name: unit-test-coverage

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: emr_test
        ports:
          - 3306:3306
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
          
      ipfs:
        image: ipfs/kubo:latest
        ports:
          - 5001:5001
          - 8080:8080

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend-app/package-lock.json

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm --prefix backend-app ci

    - name: â³ ç­‰å¾…æœåŠ¡å°±ç»ª
      run: |
        # ç­‰å¾…MySQLå°±ç»ª
        timeout 60 bash -c 'until mysqladmin ping -h localhost -P 3306 -u root -ptest_password; do sleep 1; done'
        # ç­‰å¾…IPFSå°±ç»ª
        timeout 60 bash -c 'until curl -f http://localhost:5001/api/v0/id; do sleep 1; done'

    - name: ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“
      env:
        MYSQL_HOST: localhost
        MYSQL_PORT: 3306
        MYSQL_DATABASE: emr_test
        MYSQL_USER: root
        MYSQL_PASSWORD: test_password
      run: |
        cd backend-app
        mysql -h localhost -P 3306 -u root -ptest_password emr_test < src/database/medical_records_schema.sql

    - name: ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•
      env:
        NODE_ENV: test
        MYSQL_HOST: localhost
        MYSQL_PORT: 3306
        MYSQL_DATABASE: emr_test
        MYSQL_USER: root
        MYSQL_PASSWORD: test_password
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        IPFS_API_URL: http://localhost:5001
        JWT_SECRET: test_jwt_secret
      run: npm --prefix backend-app run test:integration

  # æ„å»ºDockeré•œåƒ
  build-images:
    name: ğŸ³ æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” ç™»å½•Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # åç«¯é•œåƒæ„å»º
    - name: ğŸ“‹ æå–åç«¯å…ƒæ•°æ®
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./backend-app
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_ENV=production

    # å‰ç«¯é•œåƒæ„å»º
    - name: ğŸ“‹ æå–å‰ç«¯å…ƒæ•°æ®
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./react-app
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          REACT_APP_ENVIRONMENT=production

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ›¡ï¸ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build-images
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” è¿è¡ŒTrivyæ¼æ´æ‰«æ (åç«¯)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.build-images.outputs.backend-image }}
        format: 'sarif'
        output: 'backend-trivy-results.sarif'

    - name: ğŸ” è¿è¡ŒTrivyæ¼æ´æ‰«æ (å‰ç«¯)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.build-images.outputs.frontend-image }}
        format: 'sarif'
        output: 'frontend-trivy-results.sarif'

    - name: ğŸ“¤ ä¸Šä¼ Trivyæ‰«æç»“æœåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: |
          backend-trivy-results.sarif
          frontend-trivy-results.sarif

    - name: ğŸ”’ OWASPä¾èµ–æ£€æŸ¥
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'EMR-Blockchain'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --out reports

    - name: ğŸ“¤ ä¸Šä¼ OWASPæ‰«æç»“æœ
      uses: actions/upload-artifact@v3
      with:
        name: dependency-check-reports
        path: reports/

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-images
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: emr_test
        ports:
          - 3306:3306
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ å®‰è£…Artillery (æ€§èƒ½æµ‹è¯•å·¥å…·)
      run: npm install -g artillery@latest

    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      env:
        NODE_ENV: test
        MYSQL_HOST: localhost
        MYSQL_PASSWORD: test_password
        REDIS_HOST: localhost
      run: |
        npm --prefix backend-app ci
        npm --prefix backend-app run build
        npm --prefix backend-app start &
        sleep 30

    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        cd backend-app
        artillery run test/performance/load-test.yml --output performance-report.json

    - name: ğŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        cd backend-app
        artillery report performance-report.json --output performance-report.html

    - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: backend-app/performance-report.html

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    name: ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [security-scan, performance-tests]
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: âš™ï¸ è®¾ç½®kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ğŸ” é…ç½®Kubernetesè®¿é—®
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > $HOME/.kube/config

    - name: ğŸ¯ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
      run: |
        # æ›´æ–°é•œåƒæ ‡ç­¾
        sed -i "s|image: emr-backend:latest|image: ${{ needs.build-images.outputs.backend-image }}|g" deployment/k8s/development.yaml
        sed -i "s|image: emr-frontend:latest|image: ${{ needs.build-images.outputs.frontend-image }}|g" deployment/k8s/development.yaml
        
        # åº”ç”¨é…ç½®
        kubectl apply -f deployment/k8s/development.yaml
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/emr-backend -n emr-blockchain-dev --timeout=300s
        kubectl rollout status deployment/emr-frontend -n emr-blockchain-dev --timeout=300s

    - name: ğŸ§ª è¿è¡ŒE2Eæµ‹è¯•
      run: |
        cd react-app
        npm ci
        npm run test:e2e
      env:
        CYPRESS_BASE_URL: https://dev.emr-blockchain.com

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [security-scan, performance-tests]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: âš™ï¸ è®¾ç½®kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ğŸ” é…ç½®Kubernetesè®¿é—®
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > $HOME/.kube/config

    - name: ğŸ¯ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      run: |
        # æ›´æ–°é•œåƒæ ‡ç­¾
        sed -i "s|image: emr-backend:latest|image: ${{ needs.build-images.outputs.backend-image }}|g" deployment/k8s/production.yaml
        sed -i "s|image: emr-frontend:latest|image: ${{ needs.build-images.outputs.frontend-image }}|g" deployment/k8s/production.yaml
        
        # åº”ç”¨é…ç½®
        kubectl apply -f deployment/k8s/production.yaml
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/emr-backend -n emr-blockchain-prod --timeout=600s
        kubectl rollout status deployment/emr-frontend -n emr-blockchain-prod --timeout=600s

    - name: ğŸ” éƒ¨ç½²åå¥åº·æ£€æŸ¥
      run: |
        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        kubectl get pods -n emr-blockchain-prod
        kubectl get services -n emr-blockchain-prod
        
        # ç­‰å¾…æœåŠ¡å°±ç»ª
        kubectl wait --for=condition=ready pod -l app=emr-backend -n emr-blockchain-prod --timeout=300s
        kubectl wait --for=condition=ready pod -l app=emr-frontend -n emr-blockchain-prod --timeout=300s

    - name: ğŸ“Š éƒ¨ç½²é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ğŸ‰ EMRåŒºå—é“¾ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
          ğŸ“¦ åç«¯é•œåƒ: ${{ needs.build-images.outputs.backend-image }}
          ğŸ“¦ å‰ç«¯é•œåƒ: ${{ needs.build-images.outputs.frontend-image }}
          ğŸ”— åº”ç”¨åœ°å€: https://app.emr-blockchain.com
      if: always()

  # æ¸…ç†
  cleanup:
    name: ğŸ§¹ æ¸…ç†èµ„æº
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-prod]
    if: always()
    
    steps:
    - name: ğŸ—‘ï¸ æ¸…ç†æ—§çš„é•œåƒæ ‡ç­¾
      run: |
        # ä¿ç•™æœ€è¿‘10ä¸ªç‰ˆæœ¬çš„é•œåƒ
        echo "æ¸…ç†æ—§çš„å®¹å™¨é•œåƒ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘

    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæ—¥å¿—
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          *.log
          reports/
      if: failure()

# å…¨å±€ç¯å¢ƒå˜é‡å’Œå®‰å…¨é…ç½®
env:
  # å®‰å…¨æ‰«æé…ç½®
  SECURITY_SCAN_ENABLED: true
  VULNERABILITY_THRESHOLD: HIGH
  
  # æ€§èƒ½æµ‹è¯•é…ç½®
  PERFORMANCE_THRESHOLD_RESPONSE_TIME: 2000
  PERFORMANCE_THRESHOLD_ERROR_RATE: 1
  
  # éƒ¨ç½²é…ç½®
  DEPLOYMENT_TIMEOUT: 600
  HEALTH_CHECK_RETRIES: 5