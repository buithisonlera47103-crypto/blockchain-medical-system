name: æ€§èƒ½æµ‹è¯• CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_duration:
        description: "æµ‹è¯•æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰"
        required: false
        default: "300"
      target_tps:
        description: "ç›®æ ‡TPS"
        required: false
        default: "1000"
      enable_k6:
        description: "å¯ç”¨K6æµ‹è¯•"
        type: boolean
        required: false
        default: true

env:
  NODE_VERSION: "18"
  API_URL: "https://localhost:3001"
  FRONTEND_URL: "http://localhost:3000"
  TARGET_TPS: ${{ github.event.inputs.target_tps || '1000' }}
  LOAD_TEST_DURATION: ${{ github.event.inputs.test_duration || '300' }}
  MAX_RESPONSE_TIME: "500"
  MAX_ERROR_RATE: "0.01"
  MAX_CPU_USAGE: "80"
  MAX_MEMORY_USAGE: "90"

jobs:
  setup:
    name: ğŸ”§ ç¯å¢ƒå‡†å¤‡
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "backend-app/package-lock.json"

      - name: ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          echo "key=deps-${{ hashFiles('backend-app/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            backend-app/node_modules
            ~/.npm
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            deps-

      - name: å®‰è£…ä¾èµ–
        working-directory: backend-app
        run: |
          npm ci
          npm install -g artillery k6

  pre-test-validation:
    name: ğŸ§ª é¢„æµ‹è¯•éªŒè¯
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            backend-app/node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…å…¨å±€å·¥å…·
        run: |
          npm install -g artillery k6

      - name: éªŒè¯æµ‹è¯•é…ç½®
        working-directory: backend-app
        run: |
          echo "ğŸ” éªŒè¯Artilleryé…ç½®..."
          artillery validate test/performance/artillery.config.json

          echo "ğŸ” éªŒè¯K6è„šæœ¬..."
          k6 validate test/performance/k6-test.js

          echo "ğŸ” éªŒè¯æµ‹è¯•æ–‡ä»¶..."
          npm run test:performance -- --testNamePattern="éªŒè¯" --verbose

      - name: æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "ğŸ’» ç³»ç»Ÿä¿¡æ¯:"
          echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜å¤§å°: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
          echo "è´Ÿè½½å¹³å‡: $(uptime | awk -F'load average:' '{print $2}')"

  performance-test:
    name: ğŸš€ æ€§èƒ½æµ‹è¯•æ‰§è¡Œ
    runs-on: ubuntu-latest
    needs: [setup, pre-test-validation]
    strategy:
      matrix:
        test-type: ["api-load", "frontend-load"]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            backend-app/node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…å…¨å±€å·¥å…·
        run: |
          npm install -g artillery k6

      - name: å¯åŠ¨æµ‹è¯•æœåŠ¡
        working-directory: backend-app
        run: |
          echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."
          npm run build
          npm start &

          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          timeout 60 bash -c 'until curl -k -s https://localhost:3001/api/v1/monitoring/health; do sleep 2; done'

          echo "âœ… åç«¯æœåŠ¡å·²å¯åŠ¨"
        env:
          NODE_ENV: test

      - name: å¯åŠ¨å‰ç«¯æœåŠ¡
        if: matrix.test-type == 'frontend-load'
        working-directory: react-app
        run: |
          echo "ğŸš€ å¯åŠ¨å‰ç«¯æœåŠ¡..."
          npm ci
          npm start &

          echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨..."
          timeout 60 bash -c 'until curl -s http://localhost:3000; do sleep 2; done'

          echo "âœ… å‰ç«¯æœåŠ¡å·²å¯åŠ¨"

      - name: æ‰§è¡ŒAPIè´Ÿè½½æµ‹è¯•
        if: matrix.test-type == 'api-load'
        working-directory: backend-app
        run: |
          echo "ğŸ”¥ å¼€å§‹APIè´Ÿè½½æµ‹è¯•..."

          # å¯åŠ¨ç³»ç»Ÿç›‘æ§
          npm run performance:monitor &
          MONITOR_PID=$!

          # è¿è¡ŒArtilleryæµ‹è¯•
          npm run load-test || true

          # åœæ­¢ç›‘æ§
          kill $MONITOR_PID || true

          echo "âœ… APIè´Ÿè½½æµ‹è¯•å®Œæˆ"
        env:
          TEST_USER_EMAIL: "test@example.com"
          TEST_USER_PASSWORD: "testpassword123"

      - name: æ‰§è¡ŒK6åˆ†å¸ƒå¼æµ‹è¯•
        if: matrix.test-type == 'frontend-load' && github.event.inputs.enable_k6 != 'false'
        working-directory: backend-app
        run: |
          echo "ğŸŒ å¼€å§‹K6åˆ†å¸ƒå¼æµ‹è¯•..."

          # è¿è¡ŒK6æµ‹è¯•
          npm run k6-test || true

          echo "âœ… K6æµ‹è¯•å®Œæˆ"
        env:
          TEST_USER_EMAIL: "test@example.com"
          TEST_USER_PASSWORD: "testpassword123"

      - name: æ”¶é›†æµ‹è¯•ç»“æœ
        if: always()
        working-directory: backend-app
        run: |
          echo "ğŸ“Š æ”¶é›†æµ‹è¯•ç»“æœ..."

          # åˆ›å»ºç»“æœç›®å½•
          mkdir -p test-results/performance/artifacts

          # æ”¶é›†æ—¥å¿—æ–‡ä»¶
          if [ -f "logs/app.log" ]; then
            cp logs/app.log test-results/performance/artifacts/
          fi

          if [ -f "logs/error.log" ]; then
            cp logs/error.log test-results/performance/artifacts/
          fi

          # æ”¶é›†ç³»ç»Ÿä¿¡æ¯
          echo "ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ:" > test-results/performance/artifacts/system-info.txt
          echo "CPU: $(top -bn1 | grep 'Cpu(s)' | awk '{print $2}')" >> test-results/performance/artifacts/system-info.txt
          echo "å†…å­˜: $(free -h | grep '^Mem:')" >> test-results/performance/artifacts/system-info.txt
          echo "ç£ç›˜: $(df -h /)" >> test-results/performance/artifacts/system-info.txt

          # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“ ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶:"
          find test-results/performance -type f -name "*" | head -20

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-results-${{ matrix.test-type }}
          path: |
            backend-app/test-results/performance/
            backend-app/logs/
          retention-days: 30

  analysis:
    name: ğŸ“ˆ æ€§èƒ½åˆ†æ
    runs-on: ubuntu-latest
    needs: [performance-test]
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v3
        with:
          path: test-results/

      - name: åˆ†ææ€§èƒ½æ•°æ®
        run: |
          echo "ğŸ“Š åˆ†ææ€§èƒ½æµ‹è¯•ç»“æœ..."

          # åˆ›å»ºåˆ†ææŠ¥å‘Š
          cat > performance-analysis.md << 'EOF'
          # ğŸ¥ åŒºå—é“¾EMRç³»ç»Ÿæ€§èƒ½æµ‹è¯•æŠ¥å‘Š

          ## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ
          - **æµ‹è¯•æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Gitæäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **ç›®æ ‡TPS**: ${{ env.TARGET_TPS }}
          - **æµ‹è¯•æŒç»­æ—¶é—´**: ${{ env.LOAD_TEST_DURATION }}ç§’

          ## ğŸ¯ æ€§èƒ½ç›®æ ‡
          - âœ… å“åº”æ—¶é—´P95 < 500ms
          - âœ… é”™è¯¯ç‡ < 1%
          - âœ… CPUä½¿ç”¨ç‡ < 80%
          - âœ… å†…å­˜ä½¿ç”¨ç‡ < 90%

          ## ğŸ“Š æµ‹è¯•ç»“æœ

          ### APIè´Ÿè½½æµ‹è¯•
          EOF

          # æ£€æŸ¥æ˜¯å¦æœ‰ArtilleryæŠ¥å‘Š
          if find test-results/ -name "artillery-report.json" -type f | head -1 | read artillery_report; then
            echo "- âœ… Artilleryè´Ÿè½½æµ‹è¯•å·²å®Œæˆ" >> performance-analysis.md
            echo "- ğŸ“„ è¯¦ç»†æŠ¥å‘Š: [artillery-report.json](./test-results/performance-test-results-api-load/artillery-report.json)" >> performance-analysis.md
          else
            echo "- âŒ Artilleryè´Ÿè½½æµ‹è¯•æœªå®Œæˆæˆ–å¤±è´¥" >> performance-analysis.md
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰K6æŠ¥å‘Š
          if find test-results/ -name "k6-summary.json" -type f | head -1 | read k6_report; then
            echo "- âœ… K6åˆ†å¸ƒå¼æµ‹è¯•å·²å®Œæˆ" >> performance-analysis.md
            echo "- ğŸ“„ è¯¦ç»†æŠ¥å‘Š: [k6-summary.json](./test-results/performance-test-results-frontend-load/k6-summary.json)" >> performance-analysis.md
          else
            echo "- âŒ K6åˆ†å¸ƒå¼æµ‹è¯•æœªå®Œæˆæˆ–å¤±è´¥" >> performance-analysis.md
          fi

          cat >> performance-analysis.md << 'EOF'

          ### ç³»ç»Ÿç›‘æ§
          - ğŸ“Š ç³»ç»Ÿèµ„æºç›‘æ§å·²å¯ç”¨
          - ğŸ” è¯¦ç»†ç›‘æ§æ•°æ®è¯·æŸ¥çœ‹artifacts

          ## ğŸ’¡ ä¼˜åŒ–å»ºè®®

          åŸºäºæœ¬æ¬¡æµ‹è¯•ç»“æœï¼Œå»ºè®®ï¼š

          1. **APIä¼˜åŒ–**: ç»§ç»­ä¼˜åŒ–é«˜é¢‘APIçš„å“åº”æ—¶é—´
          2. **ç¼“å­˜ç­–ç•¥**: è€ƒè™‘å¢åŠ Redisç¼“å­˜å±‚
          3. **æ•°æ®åº“ä¼˜åŒ–**: æ£€æŸ¥æ…¢æŸ¥è¯¢å¹¶æ·»åŠ ç´¢å¼•
          4. **è´Ÿè½½å‡è¡¡**: åœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹è€ƒè™‘æ°´å¹³æ‰©å±•
          5. **ç›‘æ§å‘Šè­¦**: å»ºç«‹å®æ—¶æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

          ## ğŸ“ ç›¸å…³æ–‡ä»¶

          - [æ€§èƒ½æµ‹è¯•é…ç½®](./backend-app/test/performance/)
          - [CI/CDå·¥ä½œæµ](./.github/workflows/performance-test.yml)
          - [æµ‹è¯•ç»“æœartifacts](./test-results/)

          ---

          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
          *GitHub Actions Run: ${{ github.run_id }}*
          EOF

          echo "ğŸ“‹ æ€§èƒ½åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ"
          cat performance-analysis.md

      - name: åˆ›å»ºæ€§èƒ½æŠ¥å‘Šè¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportContent = fs.readFileSync('performance-analysis.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

      - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-analysis-report
          path: performance-analysis.md
          retention-days: 90

  notification:
    name: ğŸ“¢ æµ‹è¯•é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [performance-test, analysis]
    if: always()
    steps:
      - name: å‘é€æµ‹è¯•ç»“æœé€šçŸ¥
        run: |
          echo "ğŸ“§ å‘é€æ€§èƒ½æµ‹è¯•ç»“æœé€šçŸ¥..."

          if [ "${{ needs.performance-test.result }}" == "success" ]; then
            echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"
            echo "PERFORMANCE_TEST_STATUS=âœ… é€šè¿‡" >> $GITHUB_ENV
          else
            echo "âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥"
            echo "PERFORMANCE_TEST_STATUS=âŒ å¤±è´¥" >> $GITHUB_ENV
          fi

          echo "ğŸ“Š æµ‹è¯•æ‘˜è¦:"
          echo "- ç›®æ ‡TPS: ${{ env.TARGET_TPS }}"
          echo "- æµ‹è¯•æ—¶é•¿: ${{ env.LOAD_TEST_DURATION }}ç§’"
          echo "- æäº¤SHA: ${{ github.sha }}"
          echo "- åˆ†æ”¯: ${{ github.ref_name }}"

      - name: è®¾ç½®æµ‹è¯•çŠ¶æ€
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ needs.performance-test.result }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success' ? 
              'æ€§èƒ½æµ‹è¯•é€šè¿‡ - æ‰€æœ‰æŒ‡æ ‡ç¬¦åˆè¦æ±‚' : 
              'æ€§èƒ½æµ‹è¯•å¤±è´¥ - è¯·æ£€æŸ¥æµ‹è¯•æŠ¥å‘Š';

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'performance-test'
            });

  # å·¥ä½œæµç¨‹æ¸…ç†
  cleanup:
    name: ğŸ§¹ æ¸…ç†èµ„æº
    runs-on: ubuntu-latest
    needs: [performance-test, analysis, notification]
    if: always()
    steps:
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œè¿›ç¨‹..."

          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„è¿›ç¨‹
          pkill -f "artillery" || true
          pkill -f "k6" || true
          pkill -f "node.*test" || true

          echo "âœ… æ¸…ç†å®Œæˆ"
